using System;
using System.IO;
using Nexplore.Practices.Build.Helpers;
using Nuke.Common;
using Nuke.Common.IO;
using Nuke.Common.Tools.DotNet;
using Nuke.Common.Tools.Npm;

namespace Nexplore.Practices.Build;

partial class Build
{
    [Parameter("Directory with artifacts in the same folder structure as they got generated by the build")] readonly string PublishArtifactsDirectory;

    [Parameter("API Key for public release NuGet feed")] readonly string NuGetPublicReleaseApiKey;
    [Parameter("Public release NuGet source")] readonly string NuGetPublicReleaseSource = "https://api.nuget.org/v3/index.json";
    [Parameter("API Key for pre-release NuGet source")] readonly string NuGetPreReleaseApiKey;
    [Parameter("Pre-release NuGet source")] readonly string NuGetPreReleaseSource;

    [Parameter("API key for public release NPM registry")] readonly string NpmPublicReleaseApiKey;
    [Parameter("Public release NPM registry")] readonly string NpmPublicReleaseRegistry = "https://registry.npmjs.org";
    [Parameter("API key for pre-release NPM registry")] readonly string NpmPreReleaseApiKey;
    [Parameter("Pre-release NPM registry")] readonly string NpmPreReleaseRegistry;

    Target PublishNuGet => _ => _
        .Requires(() => PublishArtifactsDirectory)
        .Requires(() => NuGetPublicReleaseApiKey)
        .Requires(() => NuGetPublicReleaseSource)
        .Requires(() => NuGetPreReleaseApiKey)
        .Requires(() => NuGetPreReleaseSource)
        .Executes(() =>
        {
            var isPublicRelease = GitVersion.IsPublicRelease();

            var sourceUrl = isPublicRelease
                ? NuGetPublicReleaseSource
                : NuGetPreReleaseSource;

            var apiKey = isPublicRelease
                ? NuGetPublicReleaseApiKey
                : NuGetPreReleaseApiKey;

            var nuGetPackageDirectory = AbsolutePath.Create(PublishArtifactsDirectory) / "nuget";
            var nuGetPackages = nuGetPackageDirectory.GlobFiles("*.nupkg");

            Assert.NotEmpty(nuGetPackages, $"No NuGet packages found in {nuGetPackageDirectory}");

            foreach (var package in nuGetPackages)
            {
                DotNetTasks.DotNetNuGetPush(settings => settings
                    .SetApiKey(apiKey)
                    .SetSource(sourceUrl)
                    .SetTargetPath(package)
                );
            }
        });

    Target PublishNpm => _ => _
        .Requires(() => PublishArtifactsDirectory)
        .Requires(() => NpmPublicReleaseApiKey)
        .Requires(() => NpmPublicReleaseRegistry)
        .Requires(() => NpmPreReleaseApiKey)
        .Requires(() => NpmPreReleaseRegistry)
        .Executes(() =>
        {
            var isPublicRelease = GitVersion.IsPublicRelease();

            var registryUrl = isPublicRelease
                ? NpmPublicReleaseRegistry
                : NpmPreReleaseRegistry;

            var apiKey = isPublicRelease
                ? NpmPublicReleaseApiKey
                : NpmPreReleaseApiKey;

            var npmPackageDirectory = AbsolutePath.Create(PublishArtifactsDirectory) / "npm";
            var npmPackages = npmPackageDirectory.GlobFiles("*.zip");

            Assert.NotEmpty(npmPackages, $"No NPM packages found in {npmPackageDirectory}");

            foreach (var package in npmPackages)
            {
                var zipName = Path.GetFileName(package);
                var projectName = zipName[..zipName.IndexOf('.')];
                var projectDir = npmPackageDirectory / projectName;

                package.UnZipTo(projectDir);

                // Set .npmrc per project according to configuration
                var npmrc = $@"
                   registry={registryUrl}
                   //{new Uri(registryUrl).Host}/:_authToken={apiKey}
                   ";
                File.WriteAllText(projectDir / ".npmrc", npmrc);

                NpmTasks.Npm("publish", workingDirectory: projectDir);
            }
        });

    Target PublishAll => _ => _
        .DependsOn(PublishNuGet, PublishNpm);
}
