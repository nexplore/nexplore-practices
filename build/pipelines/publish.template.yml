parameters:
  - name: environment
  - name: nuget_public_release_api_key
  - name: nuget_pre_release_api_key
  - name: npm_public_release_api_key
  - name: npm_pre_release_api_key


jobs:
  - deployment: Publish
    displayName: Publish ${{ parameters.environment }}
    environment: ${{ parameters.environment }}
    workspace:
      clean: outputs
    strategy:
      runOnce:
        deploy:
          steps:
            # Disable auto download. https://docs.microsoft.com/en-us/azure/devops/pipelines/process/deployment-jobs?view=azure-devops#descriptions-of-lifecycle-hooks
            - download: none
            - checkout: self
              clean: true

            - task: UseDotNet@2
              displayName: 'Prepare global .NET Environment'
              inputs:
                 useGlobalJson: true
                 workingDirectory: 'dotnet'

            - task: UseNode@1
              displayName: 'Prepare Node.js Environment'
              inputs:
                  version: '22.14.0'

            - task: DownloadBuildArtifacts@0
              displayName: Download Artifacts
              inputs:
                downloadType: single
                artifactName: drop

            - task: CmdLine@2
              displayName: Run Publish
              inputs:
                script: ./build.sh PublishAll --publish-artifacts-directory $(Build.ArtifactStagingDirectory)/drop
              env:
                # API keys are provided explicitly as secret DevOps variables are not provided directly as env variable
                # The sources and registry values are provided as env variable and implicitly read by Nuke. If provided, Nuke would fail with multiple found values
                NUKE_NUGET_PUBLIC_RELEASE_API_KEY: ${{ parameters.nuget_public_release_api_key }}
                NUKE_NUGET_PRE_RELEASE_API_KEY: ${{ parameters.nuget_pre_release_api_key }}
                NUKE_NPM_PUBLIC_RELEASE_API_KEY: ${{ parameters.npm_public_release_api_key }}
                NUKE_NPM_PRE_RELEASE_API_KEY: ${{ parameters.npm_pre_release_api_key }}

